# vim: filetype=zsh

# NOTA: Este script monta SOLO el HOME personal de un usuario remoto vía SSHFS
#
# Lo que hace:
# - Mapea tu usuario remoto al local (idmap=user), así los  archivos se ven y
#   comportan como tuyos (para edición con Neovim).
# - Permisos se chequean localmente (default_permissions).
# - Solo tú (el que monta) tienes acceso práctico.
#
# NO usar para:
# - Carpetas compartidas entre varios usuarios
# - Datos sensibles o de sistema
# - Mantener UID/GID originales del servidor
#  mount | grep sshfs

# DEFINIR COLOR
YELLOW='\033[0;33m'
BLUE="\033[0;34m"
GREEN="\033[0;32m"
NC="\033[0m" # Sin color

local user="$1" # usuario remoto: cisne
local host="$2" # host remoto: SWAN
local mount_point="/mnt/servers/$host/$user" # Ruta de montaje

if [[ -z "$user" || -z "$host" ]]; then
    echo "Uso: kzmount-ssh <usuario> <HOST>"
    return 0
fi

# Requiere privilegios de superusuario
if ! sudo -v > /dev/null 2>&1; then
    echo -e "${YELLOW}  Se requiere autenticación sudo.${NC}"
    return 1
fi

echo -e "${BLUE}Montando vía SSHFS el directorio /home del usuario remoto${NC}"
echo

# Verificar que el grupo fuse exista
if ! getent group fuse > /dev/null; then
    echo "  Grupo 'fuse' no existe. "
    echo "Creándolo..."
    sudo groupadd fuse
fi

# Verificar que el usuario esté en el grupo fuse
if ! id -nG "$USER" | grep -qw fuse; then
    echo "  Agregando $USER al grupo 'fuse'."
    sudo usermod -a -G fuse "$USER"

    echo
    echo -e "${YELLOW}Necesitarás reiniciar sesión.${NC}"
    echo "   El usuario fue agregado al grupo 'fuse',"
    echo "   pero la sesión actual no lo refleja todavía."
    echo "   El script se detiene para evitar errores."
    return 2
fi

# Evitar ruido: ya está montado
if mountpoint -q "$mount_point"; then
    echo "  Ya está montado en: ${YELLOW}$mount_point${NC}"
    echo " - Puedes desmontar con:"
    echo "   fusermount -u <ruta>"
    echo " - También puedes listar los montajes con:"
    echo "   findmnt -t fuse.sshfs --output SOURCE,TARGET"
    echo
    return 3
fi

# Crear el punto de montaje local para SSHFS, solo si no existe
if [[ ! -d "$mount_point" ]]; then
    sudo mkdir -p "$mount_point"
    sudo chown "$USER:$USER" "$mount_point"
    sudo chmod 755 "$mount_point"
fi

# Validar permisos sobre el punto de montaje
if [[ ! -w "$mount_point" ]]; then
    echo "  Sin permiso de escritura en: $mount_point"
    echo
    echo "   Posibles causas:"
    echo "     - El directorio pertenece a root"
    echo "     - El usuario no tiene el grupo 'fuse' activo en esta sesión"
    echo
    echo "   Verificaciones sugeridas:"
    echo "     id -nG $USER"
    echo "     ls -ld /mnt/servers"
    echo
    echo "   Si acabas de agregar el usuario al grupo 'fuse',"
    echo "   cierra sesión y vuelve a entrar."
    return 4
fi

# ╒════════════════════════════════════════════════════════════╕
# │                       MONTAJE SSHFS                        │
# ╘════════════════════════════════════════════════════════════╛
if ! ssh-add -L > /dev/null 2>&1; then
    echo "${YELLOW}  No hay claves SSH cargadas.${NC}"
    echo "Abre KeePassXC para desbloquear la clave SSH (si está configurada así)."
    echo "De lo contrario, se solicitará la contraseña del servidor remoto."
    echo "  Presiona Enter para proceder con el montaje... "
    read dummy
fi

echo "  Ejecutando montaje SSHFS..."

if sshfs "$user@$host:/home/$user" "$mount_point" \
    -o ServerAliveCountMax=3 \
    -o ServerAliveInterval=15 \
    -o default_permissions \
    -o follow_symlinks \
    -o idmap=user \
    -o reconnect; then

    echo
    echo "  Montaje completado:"
    echo "${GREEN}  $user@$host -> $mount_point${NC}"

else
    echo
    echo "  Error al montar $user@$host"
    # Eliminar la carpeta creada para no ensuciar /mnt
    rmdir "$mount_point" 2> /dev/nui
