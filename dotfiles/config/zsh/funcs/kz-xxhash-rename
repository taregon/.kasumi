# vim: filetype=zsh

# La función renombra archivos agregando un digest xxHash como prefijo.
# Nota importante:
# - El digest se genera a partir del contenido del archivo, no de su nombre.
# - Cambiar el nombre del archivo no altera el digest.
# - Cualquier cambio en el contenido modifica el digest, lo que permite:
#     • Identificar archivos idénticos aunque tengan nombres distintos.
#     • Detectar cambios en el contenido.
#     • Evitar colisiones de nombres al renombrar archivos usando el digest como prefijo.

local dir="$(pwd)"

# Verifica si 'xxhsum' está instalado
if ! command -v xxhsum &> /dev/null; then
    echo "  Error: 'xxhsum' no está instalado. Instala 'xxhash' primero."
    return 1
fi

# Archivo de log (local al directorio)
local logfile="$dir/xxhash.log"

# Función auxiliar para escribir en el log
log() {
    printf '%s | %-9s | %s\n' \
        "$(date '+%F %T')" \
        "$1" \
        "$2" >> "$logfile"
}

# Itera sobre archivos regulares en el directorio actual
for file in "$dir"/*; do
    # Continúa solo si es un archivo regular (ignora directorios y enlaces)
    [[ -f "$file" ]] || continue

    # Calcula el digest xxHash del archivo (basado en el contenido)
    # Usa XXH64 explícitamente (-H1) para evitar cambios de default en xxhsum
    local digest=$(xxhsum -H1 "$file" | awk '{print $1}')

    # Nombre original del archivo
    local filename=$(basename "$file")

    # Extrae la extensión (si existe)
    local ext=""
    [[ "$filename" == *.* ]] && ext=".${filename##*.}"

    # Evita reprocesar archivos cuyo nombre ya refleja su digest xxHash.
    if [[ "$filename" == "${digest}${ext}" ]]; then
        continue
    fi

    # Nuevo nombre basado en el digest
    local new_filename="$dir/${digest}${ext}"

    # Manejo de duplicados
    if [[ -e "$new_filename" ]]; then
        new_filename="$dir/${digest}_dup${ext}"
        log "DUPLICATE" "$filename -> $(basename "$new_filename")"
    fi

    # Renombra el archivo
    if mv -- "$file" "$new_filename"; then
        log "RENAMED" "$filename -> $(basename "$new_filename")"
        echo "  Archivo renombrado: '$filename' -> '$(basename "$new_filename")'"
    else
        log "ERROR" "$filename (falló mv)"
        echo "  Error al renombrar: '$filename'"
    fi
done
