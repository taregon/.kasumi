# vim: filetype=zsh

# La función renombra archivos agregando un hash xxHash como prefijo.
# Nota importante:
# - El hash se genera a partir del contenido del archivo, no de su nombre.
# - Cambiar el nombre del archivo no altera el hash.
# - Cualquier cambio en el contenido modifica el hash, lo que permite:
#     • Identificar archivos idénticos aunque tengan nombres distintos.
#     • Detectar cambios en el contenido.
#     • Evitar colisiones de nombres al renombrar archivos usando el hash como prefijo.

local dir="$(pwd)"

# Verifica si 'xxhsum' está instalado
if ! command -v xxhsum &> /dev/null; then
    echo "  Error: 'xxhsum' no está instalado. Instala 'xxhash' primero."
    return 1
fi

# Itera sobre los archivos del directorio actual
for file in "$dir"/*; do
    # Continúa solo si es un archivo regular (ignora directorios y enlaces)
    [[ -f "$file" ]] || continue

    # Calcula el hash xxHash basado exclusivamente en el contenido del archivo
    local hash
    hash=$(xxhsum "$file" | awk '{print $1}')

    # Obtiene el nombre del archivo sin la ruta
    local filename
    filename=$(basename "$file")

    # Extrae la extensión original del archivo (si existe)
    local ext=""
    [[ "$filename" == *.* ]] && ext=".${filename##*.}"

    # Construye el nuevo nombre usando el hash como identificador del contenido
    local new_filename="$dir/${hash}${ext}"

    # Si ya existe un archivo con ese hash, marca el duplicado con el sufijo "_dup"
    if [[ -e "$new_filename" ]]; then
        new_filename="$dir/${hash}_dup${ext}"
    fi

    # Renombra el archivo
    mv -- "$file" "$new_filename"

    echo "  Archivo renombrado: '$filename' -> '$(basename "$new_filename")'"
done
